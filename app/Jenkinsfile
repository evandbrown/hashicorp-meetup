node('docker') {
  checkout scm
  dir('app') {
    stage 'Run tests, build bin'
    docker.image('golang:1.6').inside {
      sh 'go get -d -v'
      sh 'go test'
      sh 'go build'
      sh 'mkdir -p out; mv app out/'
    }

    stage 'Build images with Packer'
    def revision = rev()
    sh 'packer build -var project_id=evandbrown17 -var revision=${revision} packer.json'
    sh 'gcloud docker push gcr.io/evandbrown17/myapp:${revision}'
  }
}

def rev() {
  sh 'git rev-parse --short HEAD > .rev'
  return readFile('.rev').trim()
}
